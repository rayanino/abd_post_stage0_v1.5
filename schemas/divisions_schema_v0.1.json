{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "abd:schemas:divisions:v0.1",
  "title": "ABD Division Tree Schema v0.1",
  "description": "Schema for Stage 2 (Structure Discovery) division tree output. Each division represents a named section of the book as intended by the author or editor.",
  "type": "object",
  "required": [
    "schema_version",
    "book_id",
    "source_html_sha256",
    "pages_jsonl_sha256",
    "generator_tool",
    "generator_version",
    "generated_utc",
    "total_pages",
    "total_divisions",
    "divisions"
  ],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "const": "divisions_v0.1",
      "description": "Schema version identifier."
    },
    "book_id": {
      "type": "string",
      "minLength": 1,
      "description": "Canonical book identifier from books_registry.yaml."
    },
    "source_html_sha256": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$",
      "description": "SHA-256 of the frozen source HTML used for Pass 1. Provenance anchor."
    },
    "pages_jsonl_sha256": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$",
      "description": "SHA-256 of the Stage 1 pages.jsonl used for Pass 2. Provenance anchor."
    },
    "generator_tool": {
      "type": "string",
      "description": "Tool that produced this file, e.g. 'tools/discover_structure.py'."
    },
    "generator_version": {
      "type": "string",
      "description": "Version of the generator tool."
    },
    "generated_utc": {
      "type": "string",
      "format": "date-time",
      "description": "UTC timestamp of generation."
    },
    "total_pages": {
      "type": "integer",
      "minimum": 1,
      "description": "Total page count in the book (from pages.jsonl)."
    },
    "total_divisions": {
      "type": "integer",
      "minimum": 0,
      "description": "Total number of division nodes in the tree (excluding root)."
    },
    "toc_detected": {
      "type": "boolean",
      "description": "Whether a table of contents was detected in the book."
    },
    "structure_confidence": {
      "type": "string",
      "enum": ["high", "medium", "low", "minimal"],
      "description": "Overall confidence in the discovered structure. 'high' = most divisions are HTML-tagged. 'medium' = mix of tagged and keyword/LLM. 'low' = mostly LLM-discovered. 'minimal' = zero or near-zero structure found."
    },
    "divisions": {
      "type": "array",
      "description": "Flat list of all division nodes. Hierarchy is expressed via parent_id references. Ordered by start_seq_index (document order).",
      "items": { "$ref": "#/$defs/division_node" }
    },
    "human_overrides_applied": {
      "type": "boolean",
      "default": false,
      "description": "Whether human overrides from structure_overrides.json have been applied."
    },
    "notes": {
      "type": ["string", "null"],
      "description": "Optional free-text notes about the structure discovery run."
    }
  },
  "$defs": {
    "division_node": {
      "type": "object",
      "required": [
        "id",
        "type",
        "title",
        "level",
        "detection_method",
        "confidence",
        "digestible",
        "start_seq_index",
        "end_seq_index",
        "page_hint_start",
        "page_hint_end",
        "parent_id"
      ],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^div_[0-9]{4,}$",
          "description": "Auto-generated unique identifier. Format: div_NNNN (zero-padded, sequential)."
        },
        "type": {
          "type": "string",
          "description": "The structural keyword type. One of the keyword types from structural_patterns.yaml, or 'implicit' for LLM-discovered divisions with no keyword, or 'volume' for volume markers, or 'root' for the book root node.",
          "examples": ["باب", "فصل", "مبحث", "تقسيم", "تنبيه", "خاتمة", "فائدة", "قاعدة", "مقدمة", "حاشية", "شرح", "implicit", "volume", "root"]
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "The full heading text as it appears in the source. For implicit divisions, a descriptive title generated by the LLM."
        },
        "level": {
          "type": "integer",
          "minimum": 0,
          "description": "Hierarchy depth. 0 = root, 1 = top-level division, etc."
        },
        "detection_method": {
          "type": "string",
          "enum": ["html_tagged", "keyword_heuristic", "llm_discovered", "toc_inferred", "human_override"],
          "description": "How this division was discovered. 'html_tagged' = Pass 1 (Tier 1). 'keyword_heuristic' = Pass 2 (Tier 2). 'llm_discovered' = Pass 3 (Tier 3). 'toc_inferred' = from TOC cross-reference. 'human_override' = manually added."
        },
        "confidence": {
          "type": "string",
          "enum": ["confirmed", "high", "medium", "low"],
          "description": "'confirmed' = Pass 1 tagged heading or LLM confirmed a Pass 1/2 heading. 'high' = LLM is confident. 'medium' = probable. 'low' = uncertain, flagged for human review."
        },
        "digestible": {
          "type": "string",
          "enum": ["true", "false", "uncertain"],
          "description": "Whether this division contains content suitable for atomization. 'true' = teaching or exercise content. 'false' = editor introduction, TOC, endorsements, etc. 'uncertain' = needs human decision."
        },
        "content_type": {
          "type": ["string", "null"],
          "enum": ["teaching", "exercise", "mixed", "non_content", null],
          "description": "Content classification. 'teaching' = explanatory/definitional content. 'exercise' = تمارين/تطبيق/أسئلة. 'mixed' = contains both. 'non_content' = non-digestible. null if not yet classified."
        },
        "start_seq_index": {
          "type": "integer",
          "minimum": 0,
          "description": "seq_index of the first page of this division (inclusive). This is the authoritative page reference — robust to duplicate page numbers."
        },
        "end_seq_index": {
          "type": "integer",
          "minimum": 0,
          "description": "seq_index of the last page of this division (inclusive). For the last division in a book, this is the last page's seq_index."
        },
        "page_hint_start": {
          "type": "string",
          "description": "Human-readable page reference for the start, e.g. 'ص:١٩' or 'ج٢ ص:٥'. For display only — use start_seq_index for machine processing."
        },
        "page_hint_end": {
          "type": "string",
          "description": "Human-readable page reference for the end. For display only."
        },
        "parent_id": {
          "type": ["string", "null"],
          "description": "ID of the enclosing division. null for top-level divisions (children of root)."
        },
        "child_ids": {
          "type": "array",
          "items": { "type": "string" },
          "description": "IDs of direct children, in document order. Empty for leaf divisions."
        },
        "page_count": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of pages spanned by this division (end_seq_index - start_seq_index + 1)."
        },
        "ordinal": {
          "type": ["integer", "null"],
          "description": "The ordinal number if the heading contains one (الأول=1, الثاني=2, etc.). null if no ordinal detected."
        },
        "editor_inserted": {
          "type": "boolean",
          "default": false,
          "description": "True if this heading was inserted by an editor (detected by bracket patterns or editorial markers), not the original author."
        },
        "heading_in_html": {
          "type": "boolean",
          "default": false,
          "description": "True if this heading has a <span class='title'> tag in the source HTML."
        },
        "inline_heading": {
          "type": "boolean",
          "default": false,
          "description": "True if the heading text is embedded in a content paragraph rather than on its own line. The heading_text_boundary field marks where the heading ends and content begins."
        },
        "heading_text_boundary": {
          "type": ["integer", "null"],
          "description": "For inline headings: character offset within the line where the heading title ends and content begins. null for standalone headings."
        },
        "review_flags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Flags for human review. Examples: 'low_confidence', 'uncertain_digestibility', 'long_division', 'possible_false_positive', 'implicit_boundary', 'toc_mismatch'."
        },
        "detection_notes": {
          "type": ["string", "null"],
          "description": "Free-text notes from the detection pass explaining why this division was identified and at what confidence level."
        },
        "human_override": {
          "type": ["object", "null"],
          "description": "If a human override was applied, records what changed. null until human review.",
          "properties": {
            "action": {
              "type": "string",
              "enum": ["confirmed", "rejected", "modified", "added"]
            },
            "original_confidence": { "type": "string" },
            "override_notes": { "type": "string" }
          }
        }
      }
    }
  }
}
